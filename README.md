# Тестовое задание Betting Software

Разработать систему, принимающую пользовательские ставки на определённые события (например, спортивные).

Система должна состоять из двух независимых сервисов:

- сервис **line-provider** - провайдер информации о событиях;
- сервис **bet-maker** - принимающий ставки на эти события от пользователя.

<details>
<summary><h2>Описание сервиса line-provider</h2></summary>

Сервис должен выдавать информацию о событиях, на которые можно совершать ставки.
Система будет упрощённой, поэтому будет принимать ставки только на выигрыш первой команды.

Информация о событии должна содержать как минимум:

- уникальный идентификатор события — строка или число,
- коэффициент ставки на выигрыш — строго положительное число с двумя знаками после запятой,
- дедлайн для ставок — таймстемп, до которого на событие принимаются ставки,
- текущий статус события.

В системе событие может иметь один из трёх статусов:

- незавершённое,
- завершено выигрышем первой команды,
- завершено выигрышем второй команды и, соответственно, поражением первой (ничьих в наших событиях не бывает).

**API** сервиса **line-provider** не регламентировано и остаётся на ваше усмотрение.
Информация о событиях может храниться в памяти, без использования каких-либо
сторонних хранилищ.

</details>
<details>
<summary><h2>Описание сервиса bet-maker</h2></summary>
Сервис отвечает за постановку ставок на события пользователями.

Информация о событиях должна получаться из сервиса **line-provider**. В частности, сервису **bet-maker** необходимо узнавать об изменении статуса событий (переход в статус завершено с выигрышем или поражением), чтобы понять выиграла ставка или проиграла.

Взаимодействие между сервисами может быть реализовано, к примеру, запросами в сервис **line-provider**, вызовом callback-урла **bet-maker** при изменении статуса события на стороне **line-provider** или обменом сообщений между сервисами через очередь.

</details>

## Требования

Рекомендованный фреймворк для реализации сервисов — **FastAPI**, версия **Python** — 3.10.

Взаимодействия между сервисами **line-provider** и **bet-maker**, а также между сервисами и их хранилищами должны быть полностью асинхронными.

Сервисы **line-provider** и **bet-maker**, а также дополнительные хранилища и прочие инфраструктурные элементы должны быть докеризированы и запускаться через **docker compose**.

---

## Реализация

Стек: `Python`, `FastAPI`, `SQLAlchemy`, `PostgreSQL`, `REST API`, `RabbitMQ`, `Celery`, `Docker Compose`, `Nginx`

В качестве взаимодействия между сервисами для получения статуса проведённого события был выбран вариант обмена сообщениями через очередь.

#### Схема работы

**Сервис line-provider**
После регистрации события в сервисе `line-provider`, ставится задача на выполнение для **Celery** в `deadline`. По наступлению `deadline` задача обрабатывается, определяется статус события (WIN/LOSE), обновляется статус в БД, далее отправляется сообщение в **RabbitMQ** о завершении события и его новом статусе.

**Сервис bet-maker**
В сервисе `bet-maker` настроен **RabbitMQ consumer** для прослушивания очереди на наличии новых сообщений. Как только сообщения в очереди появляются, **consumer** ставит задачу на выполнение для **Celery**. Если в сервисе `bet-maker` есть ставки в которых учавствовало событие из сообщения, в соответствующих ставках обновляется статус (WIN/LOSE).

## Первичная настройка

```bash
~ git clone https://github.com/anton-savenchuk/BSW-Test
~ cd bsw-test
```

Необходимо изменить файл `.env.example`, указав свои переменные окружения, и переименовать его в `.env`

## Сборка и запуск docker-compose

```bash
~ cd bsw-test
~ docker compose up --build
```

## После сборки проекта сервисы доступны:

### line-provider

- API: [http://localhost/line-provider/](http://localhost/line-provider/)
- Swagger (документация): [http://localhost/line-provider/docs/](http://localhost/line-provider/docs/)

### bet-maker

- API: [http://localhost/bet-maker/](http://localhost/bet-maker/)
- Swagger (документация): [http://localhost/bet-maker/docs/](http://localhost/bet-maker/docs/)

## API

<details>
<summary><h2>line-provider</h2></summary>

**Events**

`GET /events/`

> Получить список активных событий

`GET /events/{event_id}/`

> Получить событие по ID

`POST /events/create/`

> Создать событие

`PATCH /events/update/`

> Обновить событие

</details>

<details>

<summary><h2>bet-maker</h2></summary>

**Events**

`GET /events/`

> Получить список активных событий из сервиса `line-provider`

`GET /events/{event_id}/`

> Получить событие по ID из сервиса `line-provider`

**Bets**

`GET /bets/`

> Получить список сделанных ставок

`POST /bets/bet/{event_id}`

> Получить ставку по ID

`PATCH /bets/update/`

> Обновить ставку

</details>
